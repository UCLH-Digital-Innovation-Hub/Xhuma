name: CI - Build, Test, Scan

on:
  push:
    branches: [ simplified-deployment ]
  pull_request:
    branches: [ simplified-deployment ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || 'redis-test-password' }}
      API_KEY: ${{ secrets.API_KEY || 'test-api-key' }}
      # Use API_KEY as JWTKEY for testing if not set explicitly
      JWTKEY: ${{ secrets.JWTKEY || secrets.API_KEY || 'test-key' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for proper versioning

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build the Docker image
      run: |
        echo "Building Docker image for testing..."
        docker build -f Dockerfile.test -t xhuma:test .

    - name: Run Trivy container scan on built image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: xhuma:test
        format: 'sarif'
        output: 'trivy-container-results.sarif'
        exit-code: '0' # change to 1 if we want the workflow to exit
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy container scan SARIF results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-container-results.sarif'


    - name: Run Trivy filesystem scan on source code
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'
        vuln-type: 'os,library'


    - name: Run Trivy config scan in IaC mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scanners: 'config'
        scan-ref: '.'        
        format: 'sarif'
        output: 'trivy-config-results.sarif'
        exit-code: '0'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'


    - name: Upload Trivy config scan SARIF results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-config-results.sarif'

        
    - name: Run tests with Docker Compose
      run: |
        echo "Starting test environment with Redis..."
        docker compose -f docker-compose.test.yml up --build --exit-code-from xhuma-tests xhuma-tests
      env:
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        API_KEY: ${{ env.API_KEY }}
        JWTKEY: ${{ env.JWTKEY }}

    - name: Notify on success
      if: success()
      run: |
        echo "✅ Tests have passed successfully!"
        echo "Ready for deployment to Azure."

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Tests have failed! See above logs for details."
        # Add additional notification steps here if desired (e.g., Slack, email, etc.)
